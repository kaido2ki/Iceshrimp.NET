on:
  push:
    tags:
      - '*'
jobs:
  build-and-push:
    runs-on: docker
    container:
      image: node:16-bullseye
      options: --volume /opt/iceshrimp-cache/rewrite:/buildkit-cache
    permissions:
      packages: write
    steps:
      - name: Clone repository
        run: git clone ${{ github.event.repository.clone_url }} --branch=${{ github.ref_name }} --depth=1 /iceshrimp
      - name: Install Docker Cli
        run: |-
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          chmod a+r /etc/apt/keyrings/docker.gpg
          echo \
            "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
            "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" > /etc/apt/sources.list.d/docker.list
          apt-get -qq update
          DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -qq -y docker-ce-cli docker-buildx-plugin docker-compose-plugin
      - name: Set up Docker Buildx
        uses: https://code.forgejo.org/docker/setup-buildx-action@v3
      - name: Authenticate against the registry
        uses: https://code.forgejo.org/docker/login-action@v3
        with:
          registry: iceshrimp.dev
          username: ${{ github.actor }}
          password: ${{ secrets.REGISTRY_TOKEN }}
      - name: Set environment variables
        shell: bash
        run: |
          # First, we set the docker repository we want to push to
          REPO="iceshrimp.dev/${GITHUB_REPOSITORY@L}"
          
          # We always want to tag :{version} and :pre, but only tag :latest for stable releases, and (temporarily) v2024.1-beta releases
          TAGS="$REPO:$GITHUB_REF_NAME,$REPO:pre"
          
          # The first section below can be safely removed once v2024.1 hits stable
          if [[ "$GITHUB_REF_NAME" == "v2024.1-beta"* ]]; then
            TAGS="$TAGS,$REPO:latest"
          elif [[ "$GITHUB_REF_NAME" == *"-beta"* ]] || [[ "$GITHUB_REF_NAME" == *"-pre"* ]]; then
            :
          else
            TAGS="$TAGS,$REPO:latest"
          fi

          # Finally, we pass the computed tags back to the actions environment
          echo "TAGS=$TAGS" >> "${GITHUB_ENV}"
      - name: Build and push
        uses: https://code.forgejo.org/docker/build-push-action@v5
        with:
          push: true
          tags: ${{ env.TAGS }}
          target: image-aot
          platforms: linux/amd64,linux/arm64
          provenance: false
          cache-from: type=local,src=/buildkit-cache
          cache-to: type=local,dest=/buildkit-cache
